import matplotlib.pyplot as plt
import re
import os

# --- Configuration ---
# Point this to the file generated by your bash script
INPUT_FILE = "benchmark_full.out"
OUTPUT_IMAGE = "benchmark_comparison.png"

def parse_benchmark_data(filepath):
    """
    Reads the single benchmark file and extracts stats for all algorithms.
    Returns a dictionary keyed by the Algorithm Name (e.g., 'MLKEM', 'KYBER').
    """
    if not os.path.exists(filepath):
        print(f"Error: File {filepath} not found.")
        return {}

    with open(filepath, 'r') as f:
        content = f.read()

    # Split by the separator lines "====== NAME ======"
    sections = re.split(r'======\s+(.*?)\s+======', content)
    
    parsed_data = {}
    
    # re.split returns [preamble, header1, block1, header2, block2, ...]
    for i in range(1, len(sections), 2):
        header = sections[i].strip()
        block = sections[i+1]
        
        # --- 1. Determine Category (Original vs Subverted) ---
        category = "Unknown"
        if "ORIGINAL" in header.upper():
            category = "Original"
        elif "SUBVERTED" in header.upper():
            category = "Subverted"
            
        # --- 2. Determine Algorithm Name (Clean up the header) ---
        # Removes "ORIGINAL:", "SUBVERTED:", and "(Full Span)" to get clean key
        clean_name = header.replace("ORIGINAL:", "").replace("SUBVERTED:", "")
        clean_name = re.sub(r'\(.*?\)', '', clean_name).strip().upper()
        
        # --- 3. Extract Statistics ---
        stats = {}
        mean_val = 0
        
        # Regex to match your bash script output format
        patterns = {
            'whislo': r'Minimum \(µs\):\s+([\d\.]+)',
            'q1':     r'Q1 \(µs\):\s+([\d\.]+)',
            'med':    r'Median \(µs\):\s+([\d\.]+)',
            'q3':     r'Q3 \(µs\):\s+([\d\.]+)',
            'whishi': r'Maximum \(µs\):\s+([\d\.]+)',
            'mean':   r'Mean \(µs\):\s+([\d\.]+)'
        }

        found_any = False
        for key, pattern in patterns.items():
            match = re.search(pattern, block)
            if match:
                val = float(match.group(1))
                found_any = True
                if key == 'mean':
                    mean_val = val
                else:
                    stats[key] = val
        
        if found_any:
            parsed_data[clean_name] = {
                'label': clean_name,       # e.g., MLKEM
                'full_header': header,     # For debugging
                'stats': stats,            # Boxplot stats
                'mean': mean_val,          # Mean point
                'category': category       # Color logic
            }

    return parsed_data

# --- Main Execution ---

# 1. Parse the file
all_data = parse_benchmark_data(INPUT_FILE)
print(f"Found Algorithms: {list(all_data.keys())}")

# 2. Define Comparisons (Must match the cleaned keys from step 1)
# Format: (Original_Key, Subverted_Key, Group_Label)
comparisons = [
    ("MLKEM",   "KYBER",   "Key Encapsulation (KEM)"),
    ("ED25519", "FALCON",  "Digital Signatures")
]

# 3. Prepare Plot Data
plot_items = []
positions = []
x_labels = []
current_pos = 1

for orig_key, sub_key, group_label in comparisons:
    # Add Original
    if orig_key in all_data:
        d = all_data[orig_key]
        plot_items.append({**d, 'color': '#1f77b4'}) # Blue
        positions.append(current_pos)
    else:
        print(f"Warning: {orig_key} not found in data.")

    # Add Subverted
    if sub_key in all_data:
        d = all_data[sub_key]
        plot_items.append({**d, 'color': '#d62728'}) # Red
        positions.append(current_pos + 0.8) # Slight gap
    else:
        print(f"Warning: {sub_key} not found in data.")

    # Label position (centered between the two bars)
    x_labels.append((current_pos + 0.4, group_label))
    
    # Move to next group
    current_pos += 2.5

if not plot_items:
    print("Error: No data found to plot. Check input file name and format.")
    exit()

# 4. Generate Plot
fig, ax = plt.subplots(figsize=(10, 6))

# Extract lists for plotting
box_stats = [item['stats'] for item in plot_items]
means = [item['mean'] for item in plot_items]
colors = [item['color'] for item in plot_items]
labels = [item['label'] for item in plot_items]

# Draw Boxplots
bplot = ax.bxp(box_stats, patch_artist=True, positions=positions, showfliers=False, widths=0.6)

# Apply colors
for patch, color in zip(bplot['boxes'], colors):
    patch.set_facecolor(color)
    patch.set_alpha(0.7)
    patch.set_edgecolor('black')

# Style medians
for median in bplot['medians']:
    median.set_color('black')
    median.set_linewidth(1.5)

# Plot Means
ax.scatter(positions, means, color='gold', marker='D', edgecolor='black', s=80, zorder=3, label='Mean')

# Formatting
ax.set_yscale('log') # Log scale is crucial given the timing differences
ax.set_ylabel('Latency (µs) - Log Scale')
ax.set_title('Full Handshake Operation Span: Original vs Subverted')

# X-Axis Groups
ax.set_xticks([x[0] for x in x_labels])
ax.set_xticklabels([x[1] for x in x_labels], fontweight='bold', fontsize=11)

# Individual Algo Labels (below bars)
trans = ax.get_xaxis_transform()
for pos, label in zip(positions, labels):
    ax.text(pos, -0.08, label, transform=trans, ha='center', va='top', fontsize=9)

# Grid
ax.grid(True, which="major", ls="--", alpha=0.4)
ax.grid(True, which="minor", ls=":", alpha=0.2)

# Legend
from matplotlib.lines import Line2D
legend_elements = [
    Line2D([0], [0], color='#1f77b4', lw=6, label='Original'),
    Line2D([0], [0], color='#d62728', lw=6, label='Subverted'),
    Line2D([0], [0], marker='D', color='w', markerfacecolor='gold', markeredgecolor='black', markersize=8, label='Mean')
]
ax.legend(handles=legend_elements, loc='upper left')

plt.tight_layout()
plt.savefig(OUTPUT_IMAGE, dpi=300)
print(f"Success! Plot saved to {OUTPUT_IMAGE}")
plt.show()